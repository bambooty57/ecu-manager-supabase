-- ==========================================
-- ğŸ“„ file_metadata í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
-- ==========================================
-- ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œì˜ ê°€ì¥ ì²« ë‹¨ê³„ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

CREATE TABLE IF NOT EXISTS public.file_metadata (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    work_record_id BIGINT REFERENCES public.work_records(id) ON DELETE CASCADE,
    file_name TEXT NOT NULL,
    original_name TEXT,
    file_size BIGINT,
    file_type TEXT,
    category TEXT,
    bucket_name TEXT,
    storage_path TEXT UNIQUE,
    storage_url TEXT UNIQUE,
    is_migrated BOOLEAN DEFAULT TRUE,
    migrated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- í…Œì´ë¸” ë° ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„ ì¶”ê°€
COMMENT ON TABLE public.file_metadata IS 'Storageë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ íŒŒì¼ë“¤ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.';
COMMENT ON COLUMN public.file_metadata.id IS 'ê³ ìœ  ì‹ë³„ì';
COMMENT ON COLUMN public.file_metadata.created_at IS 'ë ˆì½”ë“œ ìƒì„± ì‹œê°„';
COMMENT ON COLUMN public.file_metadata.work_record_id IS 'work_records í…Œì´ë¸” ì™¸ë˜í‚¤';
COMMENT ON COLUMN public.file_metadata.file_name IS 'Storageì— ì €ì¥ëœ ê³ ìœ  íŒŒì¼ëª…';
COMMENT ON COLUMN public.file_metadata.original_name IS 'ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì›ë³¸ íŒŒì¼ëª…';
COMMENT ON COLUMN public.file_metadata.file_size IS 'íŒŒì¼ í¬ê¸° (bytes)';
COMMENT ON COLUMN public.file_metadata.file_type IS 'íŒŒì¼ì˜ MIME íƒ€ì…';
COMMENT ON COLUMN public.file_metadata.category IS 'íŒŒì¼ ë¶„ë¥˜ (e.g., original, read, modified, photo)';
COMMENT ON COLUMN public.file_metadata.bucket_name IS 'íŒŒì¼ì´ ì €ì¥ëœ Supabase Storage ë²„í‚· ì´ë¦„';
COMMENT ON COLUMN public.file_metadata.storage_path IS 'ë²„í‚· ë‚´ íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œ';
COMMENT ON COLUMN public.file_metadata.storage_url IS 'íŒŒì¼ ì ‘ê·¼ì„ ìœ„í•œ Public URL';
COMMENT ON COLUMN public.file_metadata.is_migrated IS 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì—¬ë¶€';
COMMENT ON COLUMN public.file_metadata.migrated_at IS 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ì‹œê°„';

-- ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_file_metadata_work_record_id ON public.file_metadata(work_record_id);
CREATE INDEX IF NOT EXISTS idx_file_metadata_file_name ON public.file_metadata(file_name);
CREATE INDEX IF NOT EXISTS idx_file_metadata_category ON public.file_metadata(category);

-- RLS (Row Level Security) í™œì„±í™”
ALTER TABLE public.file_metadata ENABLE ROW LEVEL SECURITY;

-- ì •ì±… ìƒì„±: ëˆ„êµ¬ë‚˜ ì½ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
CREATE POLICY "Public read access for file metadata"
ON public.file_metadata
FOR SELECT
USING (true);

-- ì •ì±… ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„° ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can manage their own file metadata"
ON public.file_metadata
FOR ALL
USING (auth.uid() = (SELECT user_id FROM public.work_records WHERE id = work_record_id))
WITH CHECK (auth.uid() = (SELECT user_id FROM public.work_records WHERE id = work_record_id));

-- ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŒì„ ì•Œë¦¼
SELECT 'âœ… file_metadata í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆê³ , RLS ì •ì±…ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.'; 