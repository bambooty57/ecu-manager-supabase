-- =================================================================
-- ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìˆ˜ í…Œì´ë¸” ì„¤ì • (ì´ íŒŒì¼ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ì„¸ìš”!)
-- =================================================================
-- ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ì— í•„ìš”í•œ ëª¨ë“  í…Œì´ë¸”ê³¼ ì„¤ì •ì„ í•œ ë²ˆì— ì²˜ë¦¬í•©ë‹ˆë‹¤.

-- --- ë‹¨ê³„ 1: work_records í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€ ---
-- auth.users í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ëŠ” user_id ì»¬ëŸ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
ALTER TABLE public.work_records
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL;

-- user_id ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„ ì¶”ê°€
COMMENT ON COLUMN public.work_records.user_id IS 'ì‘ì—… ê¸°ë¡ì„ ìƒì„±í•œ ì‚¬ìš©ìì˜ ID';

-- ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_work_records_user_id ON public.work_records(user_id);

-- --- ë‹¨ê³„ 2: file_metadata í…Œì´ë¸” ìƒì„± ---
-- ë§ˆì´ê·¸ë ˆì´ì…˜ëœ íŒŒì¼ ì •ë³´ë¥¼ ì €ì¥í•  í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
CREATE TABLE IF NOT EXISTS public.file_metadata (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    work_record_id BIGINT REFERENCES public.work_records(id) ON DELETE CASCADE,
    file_name TEXT NOT NULL,
    original_name TEXT,
    file_size BIGINT,
    file_type TEXT,
    category TEXT,
    bucket_name TEXT,
    storage_path TEXT UNIQUE,
    storage_url TEXT UNIQUE,
    is_migrated BOOLEAN DEFAULT TRUE,
    migrated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- í…Œì´ë¸” ë° ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„ ì¶”ê°€
COMMENT ON TABLE public.file_metadata IS 'Storageë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ íŒŒì¼ë“¤ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.';
COMMENT ON COLUMN public.file_metadata.work_record_id IS 'work_records í…Œì´ë¸” ì™¸ë˜í‚¤';

-- ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_file_metadata_work_record_id ON public.file_metadata(work_record_id);

-- --- ë‹¨ê³„ 3: Row Level Security (RLS) ì •ì±… ì„¤ì • ---
-- work_records í…Œì´ë¸” RLS ì„¤ì •
ALTER TABLE public.work_records ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Users can manage their own work records" ON public.work_records;
DROP POLICY IF EXISTS "Allow all access" ON public.work_records; -- ì´ì „ ì •ì±… ì œê±°
CREATE POLICY "Users can manage their own work records"
ON public.work_records FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- file_metadata í…Œì´ë¸” RLS ì„¤ì •
ALTER TABLE public.file_metadata ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public read access for file metadata" ON public.file_metadata;
CREATE POLICY "Public read access for file metadata" ON public.file_metadata FOR SELECT USING (true);
DROP POLICY IF EXISTS "Users can manage their own file metadata" ON public.file_metadata;
CREATE POLICY "Users can manage their own file metadata" ON public.file_metadata FOR ALL
  USING (auth.uid() = (SELECT user_id FROM public.work_records WHERE id = work_record_id))
  WITH CHECK (auth.uid() = (SELECT user_id FROM public.work_records WHERE id = work_record_id));

-- --- ì™„ë£Œ ë©”ì‹œì§€ ---
SELECT 'âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìˆ˜ í…Œì´ë¸” ì„¤ì •ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'; 